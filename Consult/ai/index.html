<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Dedicated AI Page — Living System Demo</title>
  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0b1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.14);
      --stroke2:rgba(255,255,255,.22);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);

      --a:#7c3aed; /* violet */
      --b:#22c55e; /* green */
      --c:#06b6d4; /* cyan */
      --d:#f97316; /* orange */
      --e:#ef4444; /* red */

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.42);
      --radius: 22px;
      --radius2: 16px;

      --max: 1240px;
      --pad: clamp(16px, 3vw, 28px);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      --ok: rgba(34,197,94,.95);
      --warn: rgba(249,115,22,.95);
      --err: rgba(239,68,68,.95);
    }

    [data-theme="ice"]{
      --bg0:#f6f8ff;
      --bg1:#eef3ff;
      --card:rgba(0,0,0,.05);
      --card2:rgba(0,0,0,.08);
      --stroke:rgba(0,0,0,.12);
      --stroke2:rgba(0,0,0,.20);
      --text:#0b1220;
      --muted:rgba(11,18,32,.72);
      --shadow: 0 20px 70px rgba(8,12,18,.20);
      --shadow2: 0 10px 28px rgba(8,12,18,.14);
      --ok: rgba(34,197,94,.95);
      --warn: rgba(249,115,22,.95);
      --err: rgba(239,68,68,.95);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 12% 12%, rgba(124,58,237,.22), transparent 55%),
        radial-gradient(900px 700px at 85% 18%, rgba(6,182,212,.18), transparent 55%),
        radial-gradient(1100px 900px at 35% 96%, rgba(34,197,94,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .aurora{
      position:fixed; inset:-40vmax;
      pointer-events:none;
      background:
        radial-gradient(closest-side at 20% 30%, rgba(124,58,237,.18), transparent 70%),
        radial-gradient(closest-side at 80% 25%, rgba(6,182,212,.16), transparent 70%),
        radial-gradient(closest-side at 55% 85%, rgba(34,197,94,.14), transparent 70%),
        radial-gradient(closest-side at 30% 75%, rgba(249,115,22,.11), transparent 70%);
      filter: blur(40px) saturate(1.25);
      opacity:.9;
      mix-blend-mode: screen;
      transform: translate3d(0,0,0);
      animation: drift 18s ease-in-out infinite;
    }
    @keyframes drift{
      0%   { transform: translate3d(-2%, -1%, 0) rotate(0deg); }
      50%  { transform: translate3d(2%, 1.5%, 0) rotate(6deg); }
      100% { transform: translate3d(-2%, -1%, 0) rotate(0deg); }
    }

    a{ color:inherit; text-decoration:none; }
    .wrap{ width:min(var(--max),100%); margin:0 auto; padding:var(--pad); }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(10,14,26,.72), rgba(10,14,26,.26));
      border-bottom: 1px solid var(--stroke);
    }
    [data-theme="ice"] .topbar{
      background: linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,.28));
    }
    .topbar .wrap{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .mark{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(circle at 25% 30%, rgba(255,255,255,.18), transparent 45%),
        linear-gradient(135deg, rgba(124,58,237,1), rgba(6,182,212,1));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      position:relative; overflow:hidden;
    }
    .mark::after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      transform: rotate(25deg) translateX(-60%);
      animation: sheen 3.6s ease-in-out infinite;
    }
    @keyframes sheen{
      0%,55%{ transform: rotate(25deg) translateX(-70%); opacity:.0; }
      65%{ opacity:.55; }
      100%{ transform: rotate(25deg) translateX(70%); opacity:.0; }
    }
    .brand h1{ margin:0; font-size:14px; letter-spacing:.08em; text-transform:uppercase; font-weight:800; }
    .brand .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .brandtext{ display:flex; flex-direction:column; line-height:1.1; }

    .actions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-size:12px;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      box-shadow: var(--shadow2);
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: var(--stroke2); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      border-color: rgba(6,182,212,.45);
      background: linear-gradient(180deg, rgba(6,182,212,.18), rgba(255,255,255,.05));
    }

    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 6px;
      border:1px solid var(--stroke);
      border-bottom-color: rgba(0,0,0,.25);
      border-radius:8px;
      background: rgba(0,0,0,.14);
      color:var(--muted);
    }
    [data-theme="ice"] .kbd{ background: rgba(255,255,255,.55); border-bottom-color: rgba(0,0,0,.1); }

    /* General panels/cards */
    .panel{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(620px 340px at 20% 20%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(620px 340px at 80% 28%, rgba(6,182,212,.18), transparent 60%),
        radial-gradient(720px 380px at 60% 92%, rgba(34,197,94,.14), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .panelInner{ position:relative; padding: clamp(16px, 2.6vw, 26px); }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .cardInner{ padding: 16px; position:relative; }

    .mono{ font-family:var(--mono); color:var(--muted); font-size:12px; line-height:1.55; white-space:pre-wrap; word-break:break-word; }
    .muted{ color:var(--muted); }

    /* Layout */
    .hero{ padding: clamp(18px, 4vw, 42px) 0 10px; }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 18px;
      align-items:stretch;
    }
    @media (max-width: 980px){ .heroGrid{ grid-template-columns:1fr; } .brand{ min-width:auto; } }

    .heroTitle{
      font-size: clamp(30px, 4vw, 54px);
      line-height: 1.02;
      margin:0;
      letter-spacing:-.02em;
    }
    .heroTitle .glow{
      background: linear-gradient(90deg, rgba(124,58,237,1), rgba(6,182,212,1), rgba(34,197,94,1));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 12px 28px rgba(124,58,237,.22));
    }
    .heroP{ margin: 14px 0 0; color: var(--muted); font-size: 14px; line-height:1.55; max-width: 78ch; }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    [data-theme="ice"] .badge{ background: rgba(255,255,255,.55); }

    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top:18px; }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.12);
      padding:8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
      user-select:none;
    }
    [data-theme="ice"] .chip{ background: rgba(255,255,255,.45); }

    .dot{ width:8px; height:8px; border-radius:999px; background: var(--ok); box-shadow: 0 0 0 5px rgba(34,197,94,.12); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 5px rgba(249,115,22,.12); }
    .dot.err{ background: var(--err); box-shadow: 0 0 0 5px rgba(239,68,68,.12); }

    .miniHeader{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .miniHeader h3{ margin:0; font-size: 13px; letter-spacing:.08em; text-transform:uppercase; color: var(--muted); }
    .miniHeader .pill{
      font-family: var(--mono);
      font-size: 11px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      padding:6px 10px;
      background: rgba(0,0,0,.12);
      color: var(--muted);
      white-space:nowrap;
    }
    [data-theme="ice"] .miniHeader .pill{ background: rgba(255,255,255,.55); }

    .viz{
      border-radius: 18px;
      border:1px solid var(--stroke);
      background:
        radial-gradient(600px 280px at 30% 20%, rgba(124,58,237,.20), transparent 65%),
        radial-gradient(560px 260px at 75% 50%, rgba(6,182,212,.18), transparent 68%),
        radial-gradient(640px 320px at 45% 88%, rgba(34,197,94,.12), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      overflow:hidden;
      position:relative;
    }
    canvas{ display:block; width:100%; height:100%; }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .col-12{ grid-column: span 12; }
    .col-8{ grid-column: span 8; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    @media (max-width: 980px){ .col-8,.col-6,.col-4{ grid-column: span 12; } }

    .section{ margin-top: 18px; padding: 12px 0 0; }
    .sectionHead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin: 22px 0 12px;
    }
    .sectionHead h2{ margin:0; font-size: 18px; letter-spacing:.02em; }
    .sectionHead p{ margin:0; color: var(--muted); font-size: 13px; max-width: 74ch; }

    .toolbar{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:10px; margin: 12px 0 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row .btn{ flex:0 0 auto; }

    .input, textarea{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.12);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
      font-size: 13px;
      font-family: var(--sans);
    }
    [data-theme="ice"] .input, [data-theme="ice"] textarea{ background: rgba(255,255,255,.55); }
    textarea{ min-height: 140px; resize: vertical; }

    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .split{ grid-template-columns:1fr; } }

    .resultBox{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 12px;
      min-height: 140px;
    }
    [data-theme="ice"] .resultBox{ background: rgba(255,255,255,.45); }

    /* Builder mode */
    .builderOnly{ display:none; }
    [data-mode="builder"] .builderOnly{ display:block; }
    [data-mode="builder"] .viewerOnly{ display:none; }

    /* Collapsible */
    details{
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(0,0,0,.10);
      overflow:hidden;
    }
    [data-theme="ice"] details{ background: rgba(255,255,255,.55); }
    summary{
      cursor:pointer;
      padding: 12px 14px;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      user-select:none;
      font-size: 13px;
      color: var(--muted);
    }
    summary::-webkit-details-marker{ display:none; }
    details[open] summary{ border-bottom:1px solid var(--stroke); }
    .chev{ font-family:var(--mono); opacity:.75; }

    /* Decision table */
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius: 16px;
    }
    .table th, .table td{
      text-align:left;
      padding: 10px 10px;
      font-size: 13px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(0,0,0,.08);
    }
    [data-theme="ice"] .table th, [data-theme="ice"] .table td{ background: rgba(255,255,255,.55); }
    .table th{
      font-size: 11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .table tr:last-child td{ border-bottom:none; }
    .num{
      width: 92px;
      font-family: var(--mono);
      text-align:right;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      color:var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      outline:none;
    }
    [data-theme="ice"] .num{ background: rgba(255,255,255,.55); }
    .name{
      width: 100%;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      color:var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      outline:none;
      font-size: 13px;
    }
    [data-theme="ice"] .name{ background: rgba(255,255,255,.55); }

    /* Stream */
    .streamLog{
      height: 170px;
      overflow:auto;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      line-height:1.55;
    }
    [data-theme="ice"] .streamLog{ background: rgba(255,255,255,.45); }
    .spark{
      height: 70px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(0,0,0,.08);
      overflow:hidden;
      position:relative;
    }
    [data-theme="ice"] .spark{ background: rgba(255,255,255,.55); }

    /* Agent list */
    .agentBar{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .agent{
      border:1px solid var(--stroke);
      border-radius: 999px;
      padding: 8px 10px;
      background: rgba(0,0,0,.10);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease;
    }
    [data-theme="ice"] .agent{ background: rgba(255,255,255,.55); }
    .agent .lamp{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.20);
      box-shadow: 0 0 0 0 rgba(6,182,212,.0);
      transition: box-shadow .15s ease, background .15s ease, transform .15s ease;
    }
    .agent.active{
      border-color: rgba(6,182,212,.45);
      transform: translateY(-1px);
    }
    .agent.active .lamp{
      background: rgba(6,182,212,.95);
      box-shadow: 0 0 0 6px rgba(6,182,212,.14);
      transform: scale(1.05);
    }

    /* Footer */
    footer{
      margin: 26px 0 38px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    /* Reveal */
    .reveal{ opacity:0; transform: translateY(10px); transition: opacity .5s ease, transform .5s ease; }
    .reveal.in{ opacity:1; transform: translateY(0); }

    /* Command palette */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 100;
    }
    .modal.on{ display:flex; }
    .palette{
      width:min(760px, 100%);
      border:1px solid var(--stroke2);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(10,14,26,.92), rgba(10,14,26,.72));
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    [data-theme="ice"] .palette{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
    }
    .paletteTop{
      padding: 12px;
      border-bottom: 1px solid var(--stroke);
      display:flex; gap:10px; align-items:center;
    }
    .paletteList{ max-height: 360px; overflow:auto; }
    .cmd{
      padding: 12px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      cursor:pointer; user-select:none;
      background: rgba(255,255,255,.02);
    }
    .cmd:hover{ background: rgba(255,255,255,.06); }
    [data-theme="ice"] .cmd{ background: rgba(0,0,0,.02); }
    [data-theme="ice"] .cmd:hover{ background: rgba(0,0,0,.05); }
    .cmd .left{ display:flex; flex-direction:column; gap:3px; }
    .cmd .t{ font-size: 13px; }
    .cmd .d{ font-size: 12px; color: var(--muted); }
    .cmd .right{ display:flex; gap:8px; align-items:center; }

    @media (prefers-reduced-motion: reduce){
      .aurora{ animation:none; }
      .mark::after{ animation:none; }
      .btn{ transition:none; }
      .reveal{ transition:none; opacity:1; transform:none; }
    }
  </style>
</head>

<body>
  <div class="aurora" aria-hidden="true"></div>

  <header class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="mark" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 2c4.6 0 8.4 3.7 8.4 8.3 0 3.7-2.4 6.9-5.8 8.0v1.9H9.4v-1.9C6 17.2 3.6 14 3.6 10.3 3.6 5.7 7.4 2 12 2Z" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
            <path d="M8.4 10.3h7.2M9.3 7.8h5.4M9.1 12.8h5.8" stroke="rgba(255,255,255,.65)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brandtext">
          <h1>Dedicated AI Page</h1>
          <div class="sub">One living system • Objective → signals → decisions → agents</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnPalette" title="Command palette">
          Command <span class="kbd">Ctrl</span><span class="kbd">K</span>
        </button>
        <button class="btn" id="btnMode" title="Toggle Viewer/Builder mode">
          Mode <span class="kbd">M</span>
        </button>
        <button class="btn" id="btnTheme" title="Toggle theme">
          Theme <span class="kbd">T</span>
        </button>
        <button class="btn" id="btnFocus" title="Focus mode (hide aurora)">
          Focus <span class="kbd">F</span>
        </button>
        <button class="btn primary" id="btnRunMission" title="Run a full cycle">
          Run Cycle <span class="kbd">R</span>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- HERO -->
    <section class="hero">
      <div class="heroGrid">
        <div class="panel reveal">
          <div class="panelInner">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div style="flex:1 1 auto;">
                <h2 class="heroTitle">
                  Watch a system <span class="glow">think</span>.
                </h2>
                <p class="heroP">
                  This page is not a set of widgets. It’s one persistent state machine: it ingests signals, updates assumptions,
                  re-scores decisions, and routes work to specialized agents — live, in your browser.
                </p>
              </div>
              <div class="badge viewerOnly" id="audienceBadge">Viewer Mode</div>
              <div class="badge builderOnly" id="audienceBadgeB">Builder Mode</div>
            </div>

            <div class="chips" aria-label="system status">
              <div class="chip"><span class="dot" id="dotRun"></span> Cycle: <span id="cycleState">READY</span></div>
              <div class="chip"><span class="dot warn" id="dotRisk"></span> Uncertainty: <span id="riskState">—</span></div>
              <div class="chip"><span class="dot" id="dotConf"></span> Confidence: <span id="confState">—</span></div>
              <div class="chip"><span class="dot" id="dotPerf"></span> Render: <span id="fpsState">~60</span> fps</div>
            </div>

            <div class="section" style="margin-top:14px;">
              <div class="sectionHead" style="margin:10px 0 10px;">
                <div>
                  <h2 style="font-size:16px;margin:0;">Objective</h2>
                  <p class="muted" style="margin-top:4px;">The single constraint-driven mission this system is optimizing.</p>
                </div>
                <div class="badge" id="objectiveHealth">status: —</div>
              </div>

              <div class="card">
                <div class="cardInner">
                  <div class="split">
                    <div>
                      <textarea id="objectiveIn" spellcheck="false">Build a next-level single-page demo that proves system design: fast, coherent, visually strong, and transparent about tradeoffs.</textarea>
                      <div class="toolbar">
                        <div class="row">
                          <button class="btn" id="btnApplyObjective">Apply Objective</button>
                          <button class="btn" id="btnObjectiveSample">Load Sample</button>
                          <button class="btn" id="btnResetAll">Reset System</button>
                        </div>
                      </div>
                    </div>
                    <div class="resultBox">
                      <div class="mono" id="objectiveOut">System brief will appear here.</div>
                    </div>
                  </div>

                  <div class="builderOnly" style="margin-top:12px;">
                    <details open>
                      <summary>
                        <span>Builder: State Snapshot (live)</span>
                        <span class="chev">toggle</span>
                      </summary>
                      <div style="padding:12px;">
                        <div class="mono" id="stateDump">—</div>
                      </div>
                    </details>
                  </div>

                </div>
              </div>
            </div>

            <div class="toolbar" style="margin-top:14px;">
              <div class="row">
                <button class="btn" data-jump="#signals">Signals</button>
                <button class="btn" data-jump="#decisions">Decisions</button>
                <button class="btn" data-jump="#agents">Agents</button>
                <button class="btn" data-jump="#telemetry">Telemetry</button>
              </div>
              <div class="badge" id="clock">—</div>
            </div>
          </div>
        </div>

        <div class="panel reveal">
          <div class="panelInner">
            <div class="miniHeader">
              <h3>System Activity</h3>
              <div class="pill">events: <span id="evtCount">0</span> • last: <span id="evtLast">—</span></div>
            </div>

            <div class="viz" style="height: 240px;">
              <canvas id="activityCanvas"></canvas>
            </div>

            <div class="agentBar" id="agentBar" aria-label="agents"></div>

            <div class="builderOnly" style="margin-top:12px;">
              <details>
                <summary>
                  <span>Builder: Event Trace (why things changed)</span>
                  <span class="chev">toggle</span>
                </summary>
                <div style="padding:12px;">
                  <div class="streamLog" id="traceLog" style="height: 190px;"></div>
                </div>
              </details>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- SIGNALS -->
    <section class="section" id="signals">
      <div class="sectionHead reveal">
        <div>
          <h2>Signals</h2>
          <p>External inputs and internal constraints. These drive decisions automatically.</p>
        </div>
        <div class="badge" id="sigBadge">live</div>
      </div>

      <div class="grid">
        <div class="card col-8 reveal">
          <div class="cardInner">
            <h3 style="margin:0 0 8px; font-size:14px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);">Input Layer</h3>
            <p class="muted" style="margin:0 0 10px;">Paste a requirement, customer ask, or rough idea. The system extracts constraints and updates assumptions.</p>
            <div class="split">
              <div>
                <textarea id="signalIn" spellcheck="false">Make it feel alive. Keep it fast. Show decision-making that reacts to state changes. Keep it explainable in Builder Mode.</textarea>
                <div class="toolbar">
                  <div class="row">
                    <button class="btn" id="btnIngest">Ingest Signals</button>
                    <button class="btn" id="btnSignalSample">Load Sample</button>
                    <button class="btn" id="btnClearSignals">Clear</button>
                  </div>
                  <div class="badge">Ctrl/Cmd+Enter</div>
                </div>
              </div>
              <div class="resultBox">
                <div class="mono" id="signalOut">Extracted constraints will appear here.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card col-4 reveal">
          <div class="cardInner">
            <h3 style="margin:0 0 8px; font-size:14px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);">Constraints</h3>
            <p class="muted" style="margin:0 0 12px;">These sliders update the system state and re-rank decisions.</p>

            <div class="mono" style="margin-bottom:6px;">Complexity (higher = harder)</div>
            <input class="input" id="sComplex" type="range" min="0" max="100" value="28" />
            <div class="mono" style="margin:8px 0 6px;">Uncertainty (higher = less confident)</div>
            <input class="input" id="sUncert" type="range" min="0" max="100" value="34" />
            <div class="mono" style="margin:8px 0 6px;">Performance Budget (higher = more strict)</div>
            <input class="input" id="sPerf" type="range" min="0" max="100" value="40" />
            <div class="mono" style="margin:8px 0 6px;">Polish Demand (higher = more aesthetic)</div>
            <input class="input" id="sPolish" type="range" min="0" max="100" value="62" />

            <div class="toolbar">
              <div class="badge" id="constraintReadout">—</div>
              <button class="btn" id="btnNudge">Nudge State</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- DECISIONS -->
    <section class="section" id="decisions">
      <div class="sectionHead reveal">
        <div>
          <h2>Decisions</h2>
          <p>The system ranks options based on the objective + current state. Telemetry changes this automatically.</p>
        </div>
        <div class="badge" id="decBadge">auto</div>
      </div>

      <div class="grid">
        <div class="card col-8 reveal">
          <div class="cardInner">
            <h3 style="margin:0 0 10px; font-size:14px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);">Option Set</h3>

            <table class="table" aria-label="decision table">
              <thead>
                <tr>
                  <th style="width:36%;">Option</th>
                  <th>Impact</th>
                  <th>Speed</th>
                  <th>Risk</th>
                  <th>Polish</th>
                </tr>
              </thead>
              <tbody id="optBody"></tbody>
            </table>

            <div class="toolbar">
              <div class="row">
                <button class="btn" id="btnAddOpt">Add Option</button>
                <button class="btn" id="btnRecalc">Recalculate</button>
                <button class="btn" id="btnResetDecision">Reset Options</button>
              </div>
              <div class="badge" id="rankBadge">ranked</div>
            </div>
          </div>
        </div>

        <div class="card col-4 reveal">
          <div class="cardInner">
            <h3 style="margin:0 0 8px; font-size:14px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);">Reasoning</h3>
            <p class="muted" style="margin:0 0 12px;">Weights auto-tune based on constraints. Builder Mode shows the math.</p>

            <div class="row" style="gap:10px;">
              <label style="flex:1 1 48%;">
                <div class="mono">Impact</div>
                <input class="num" id="wImpact" type="number" min="0" step="0.25" value="1.25" />
              </label>
              <label style="flex:1 1 48%;">
                <div class="mono">Speed</div>
                <input class="num" id="wSpeed" type="number" min="0" step="0.25" value="1.00" />
              </label>
              <label style="flex:1 1 48%;">
                <div class="mono">Risk</div>
                <input class="num" id="wRisk" type="number" min="0" step="0.25" value="0.90" />
              </label>
              <label style="flex:1 1 48%;">
                <div class="mono">Polish</div>
                <input class="num" id="wPolish" type="number" min="0" step="0.25" value="0.85" />
              </label>
            </div>

            <div class="resultBox" style="margin-top:12px; min-height: 230px;">
              <div class="mono" id="decisionOut">—</div>
            </div>

            <div class="builderOnly" style="margin-top:12px;">
              <details>
                <summary>
                  <span>Builder: Weight Auto-Tune Rules</span>
                  <span class="chev">toggle</span>
                </summary>
                <div style="padding:12px;">
                  <div class="mono" id="tuneRules">—</div>
                </div>
              </details>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- AGENTS + GRAPH -->
    <section class="section" id="agents">
      <div class="sectionHead reveal">
        <div>
          <h2>Agents</h2>
          <p>Specialized modules. They “light up” when they act. Drag nodes in the graph below.</p>
        </div>
        <div class="badge">Drag nodes • Click an agent chip</div>
      </div>

      <div class="grid">
        <div class="card col-4 reveal">
          <div class="cardInner">
            <h3 style="margin:0 0 10px; font-size:14px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);">Agent Brief</h3>
            <div class="resultBox" style="min-height: 260px;">
              <div class="mono" id="agentBrief">Click an agent above (right panel) or a node in the graph.</div>
            </div>
          </div>
        </div>

        <div class="card col-8 reveal">
          <div class="cardInner">
            <div class="miniHeader">
              <h3>Force Graph (Canvas)</h3>
              <div class="pill">Nodes: <span id="nodeCount">—</span> • Links: <span id="linkCount">—</span> • state: <span id="graphState">running</span></div>
            </div>

            <div class="viz" style="height: 380px;">
              <canvas id="graphCanvas"></canvas>
            </div>

            <div class="toolbar">
              <div class="row">
                <button class="btn" id="btnReseed">Reseed</button>
                <button class="btn" id="btnCenter">Center</button>
                <button class="btn" id="btnFreeze">Freeze</button>
              </div>
              <div class="badge" id="graphHint">R = reseed</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TELEMETRY -->
    <section class="section" id="telemetry">
      <div class="sectionHead reveal">
        <div>
          <h2>Telemetry</h2>
          <p>Internal state stream. This affects decisions and confidence. Viewer Mode keeps it compact.</p>
        </div>
        <div class="badge" id="streamBadge">streaming</div>
      </div>

      <div class="grid">
        <div class="card col-8 reveal">
          <div class="cardInner">
            <details id="telemetryDetails">
              <summary>
                <span>Viewer: Telemetry Summary (expand to see the full log)</span>
                <span class="chev" id="telemetryChev">expand</span>
              </summary>
              <div style="padding:12px;">
                <div class="streamLog" id="log"></div>
                <div class="toolbar">
                  <div class="row">
                    <button class="btn" id="btnPause">Pause</button>
                    <button class="btn" id="btnStep">Step</button>
                    <button class="btn" id="btnResetStream">Reset</button>
                  </div>
                  <div class="badge" id="evtRate">rate: —</div>
                </div>
              </div>
            </details>

            <div class="viewerOnly" style="margin-top:12px;">
              <div class="resultBox">
                <div class="mono" id="telemetrySummary">—</div>
              </div>
            </div>

          </div>
        </div>

        <div class="card col-4 reveal">
          <div class="cardInner">
            <h3 style="margin:0 0 8px; font-size:14px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);">Sparklines</h3>
            <div class="mono" style="margin-bottom:10px;">Load • Momentum • Risk</div>
            <div class="spark"><canvas id="sparkA"></canvas></div>
            <div style="height:10px;"></div>
            <div class="spark"><canvas id="sparkB"></canvas></div>
            <div style="height:10px;"></div>
            <div class="spark"><canvas id="sparkC"></canvas></div>
          </div>
        </div>
      </div>
    </section>

    <footer class="reveal">
      This is a coherent system demo: objective → signals → state → decisions → agents.  
      Shortcuts: <span class="kbd">Ctrl/Cmd+K</span> palette • <span class="kbd">M</span> mode • <span class="kbd">T</span> theme • <span class="kbd">F</span> focus • <span class="kbd">R</span> run cycle / reseed
    </footer>
  </main>

  <!-- Command Palette -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="palette" role="dialog" aria-modal="true" aria-label="Command palette">
      <div class="paletteTop">
        <input class="input" id="cmdSearch" placeholder="Type a command… (ex: mode, cycle, telemetry, graph)" />
        <button class="btn" id="btnClose">Close <span class="kbd">Esc</span></button>
      </div>
      <div class="paletteList" id="cmdList"></div>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      // ============= Utils
      const $ = (q, el=document) => el.querySelector(q);
      const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
      const clamp = (n,a,b) => Math.max(a, Math.min(b,n));
      const now = () => performance.now();
      const fmt = (n) => (Number.isFinite(n) ? n.toFixed(2) : "—");
      const esc = (s) => String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");

      const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      // ============= Persistent System State
      const SYSTEM = {
        objective: "",
        constraints: { complexity: 0.28, uncertainty: 0.34, perfBudget: 0.40, polishDemand: 0.62 },
        weights: { impact: 1.25, speed: 1.00, risk: 0.90, polish: 0.85 },
        derived: { confidence: 0.0, risk: 0.0, objectiveHealth: 0.0 },
        signals: { keywords: [], intents: [], constraints: [] },
        telemetry: { load: 0.0, momentum: 0.0, risk: 0.0, lastTag: "OK" },
        counters: { events: 0 },
        mode: "viewer", // viewer | builder
      };

      // ============= Agents (lights + trace)
      const AGENTS = [
        { id:"orchestrator", name:"Orchestrator",  about:"Coordinates the cycle. Decides which agents run and in what order.", cares:["objective","constraints","telemetry"] },
        { id:"intake",       name:"Intake",        about:"Extracts constraints and intent from inputs.", cares:["signal text","objective"] },
        { id:"state",        name:"State",         about:"Maintains internal state and updates confidence based on uncertainty + risk.", cares:["telemetry","constraints"] },
        { id:"planner",      name:"Planner",       about:"Turns objective + constraints into prioritized actions.", cares:["objective","tradeoffs"] },
        { id:"scorer",       name:"Scorer",        about:"Ranks options using tuned weights and current risk/confidence.", cares:["weights","options","risk"] },
        { id:"visual",       name:"Visual",        about:"Renders the system activity and agent graph without heavy libraries.", cares:["canvas","fps"] },
      ];
      const agentIndex = new Map(AGENTS.map(a => [a.id,a]));

      // Trace log (builder)
      const TRACE_MAX = 220;
      function trace(agentId, msg){
        SYSTEM.counters.events++;
        $("#evtCount").textContent = String(SYSTEM.counters.events);
        $("#evtLast").textContent = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});

        const stamp = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        const line = `[${stamp}] ${agentIndex.get(agentId)?.name || agentId}: ${msg}`;
        const log = $("#traceLog");
        if(!log) return;
        const cur = log.textContent.split("\n").filter(Boolean);
        cur.push(line);
        log.textContent = cur.slice(-TRACE_MAX).join("\n");
        log.scrollTop = log.scrollHeight;
      }

      // Agent bar (right panel)
      function renderAgentBar(){
        const bar = $("#agentBar");
        bar.innerHTML = "";
        for(const a of AGENTS){
          const el = document.createElement("div");
          el.className = "agent";
          el.setAttribute("data-agent", a.id);
          el.innerHTML = `<span class="lamp" aria-hidden="true"></span><span>${esc(a.name)}</span>`;
          el.addEventListener("click", () => showAgent(a.id));
          bar.appendChild(el);
        }
      }
      function pulseAgent(agentId, ms=380){
        const el = $(`.agent[data-agent="${agentId}"]`);
        if(!el) return;
        el.classList.add("active");
        setTimeout(() => el.classList.remove("active"), ms);
      }
      function showAgent(agentId){
        const a = agentIndex.get(agentId);
        if(!a) return;
        pulseAgent(agentId, 520);
        $("#agentBrief").textContent =
`${a.name}
—
${a.about}

Cares about:
- ${a.cares.join("\n- ")}

Recent state:
- confidence=${fmt(SYSTEM.derived.confidence)}
- uncertainty=${fmt(SYSTEM.constraints.uncertainty)}
- risk=${fmt(SYSTEM.telemetry.risk)}
- perfBudget=${fmt(SYSTEM.constraints.perfBudget)}`;
      }

      // ============= Theme / Focus / Mode
      const root = document.documentElement;
      const aurora = document.querySelector(".aurora");
      const THEME_KEY = "ai_living_theme";
      const FOCUS_KEY = "ai_living_focus";
      const MODE_KEY  = "ai_living_mode";

      function setTheme(theme){
        if(theme) root.setAttribute("data-theme", theme);
        else root.removeAttribute("data-theme");
        localStorage.setItem(THEME_KEY, theme || "");
      }
      function toggleTheme(){
        const cur = root.getAttribute("data-theme");
        setTheme(cur === "ice" ? "" : "ice");
      }
      function setFocus(on){
        aurora.style.display = on ? "none" : "";
        localStorage.setItem(FOCUS_KEY, on ? "1" : "0");
      }
      function toggleFocus(){
        const on = (localStorage.getItem(FOCUS_KEY) === "1");
        setFocus(!on);
      }
      function setMode(mode){
        SYSTEM.mode = mode;
        root.setAttribute("data-mode", mode);
        $("#btnMode").textContent = `Mode (${mode === "builder" ? "Builder" : "Viewer"})`;
        localStorage.setItem(MODE_KEY, mode);
        trace("orchestrator", `mode set: ${mode}`);
        updateStateDump();
      }
      function toggleMode(){
        setMode(SYSTEM.mode === "builder" ? "viewer" : "builder");
      }

      // restore
      const savedTheme = localStorage.getItem(THEME_KEY) || "";
      if(savedTheme) setTheme(savedTheme);
      setFocus(localStorage.getItem(FOCUS_KEY) === "1");
      const savedMode = localStorage.getItem(MODE_KEY) || "viewer";
      setMode(savedMode);

      $("#btnTheme").addEventListener("click", toggleTheme);
      $("#btnFocus").addEventListener("click", toggleFocus);
      $("#btnMode").addEventListener("click", toggleMode);

      // ============= Smooth jumps
      $$("[data-jump]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-jump");
          const target = document.querySelector(id);
          if(target) target.scrollIntoView({ behavior:"smooth", block:"start" });
        });
      });

      // ============= Reveal
      if(!reduceMotion){
        const io = new IntersectionObserver((entries) => {
          for(const e of entries){
            if(e.isIntersecting){
              e.target.classList.add("in");
              io.unobserve(e.target);
            }
          }
        }, { threshold: 0.12 });
        $$(".reveal").forEach(el => io.observe(el));
      } else {
        $$(".reveal").forEach(el => el.classList.add("in"));
      }

      // ============= Clock
      function tickClock(){
        const d = new Date();
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        const ss = String(d.getSeconds()).padStart(2,"0");
        $("#clock").textContent = `${hh}:${mm}:${ss}`;
      }
      setInterval(tickClock, 250); tickClock();

      // ============= Canvas helpers
      function resizeCanvas(c, ctx){
        const rect = c.getBoundingClientRect();
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        c.width = Math.floor(rect.width * dpr);
        c.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        return { w: rect.width, h: rect.height, dpr };
      }

      // ============= Activity Canvas (system heartbeat + agent pulses)
      const activityCanvas = $("#activityCanvas");
      const actx = activityCanvas.getContext("2d", { alpha:true });
      let aW=0, aH=0;
      const activity = new Float32Array(180);
      let aIdx = 0;

      function seedActivity(){
        const r = resizeCanvas(activityCanvas, actx);
        aW = r.w; aH = r.h;
      }
      function pushActivity(v){
        activity[aIdx] = v;
        aIdx = (aIdx + 1) % activity.length;
      }
      function drawActivity(){
        actx.clearRect(0,0,aW,aH);

        // background faint grid
        actx.globalAlpha = 0.22;
        actx.strokeStyle = getComputedStyle(root).getPropertyValue("--stroke");
        actx.lineWidth = 1;
        actx.beginPath();
        for(let x=0;x<=aW;x+=aW/8){ actx.moveTo(x,0); actx.lineTo(x,aH); }
        for(let y=0;y<=aH;y+=aH/4){ actx.moveTo(0,y); actx.lineTo(aW,y); }
        actx.stroke();
        actx.globalAlpha = 1;

        // waveform
        actx.lineWidth = 2;
        const grad = actx.createLinearGradient(0,0,aW,0);
        grad.addColorStop(0, "rgba(124,58,237,.85)");
        grad.addColorStop(.5,"rgba(6,182,212,.85)");
        grad.addColorStop(1, "rgba(34,197,94,.85)");
        actx.strokeStyle = grad;

        actx.beginPath();
        for(let i=0;i<activity.length;i++){
          const idx = (aIdx + i) % activity.length;
          const v = activity[idx];
          const x = (i/(activity.length-1)) * aW;
          const y = aH - (v * (aH-14)) - 7;
          if(i===0) actx.moveTo(x,y); else actx.lineTo(x,y);
        }
        actx.stroke();

        // status marker dot
        const last = activity[(aIdx + activity.length - 1) % activity.length];
        const ex = aW, ey = aH - (last*(aH-14)) - 7;
        actx.fillStyle = "rgba(234,240,255,.90)";
        actx.beginPath();
        actx.arc(ex, ey, 3.2, 0, Math.PI*2);
        actx.fill();
      }

      seedActivity();
      window.addEventListener("resize", seedActivity);

      // ============= FPS indicator
      let fps=60, lastFpsT=now(), frames=0;
      function fpsLoop(t){
        frames++;
        if(t - lastFpsT > 700){
          fps = Math.round((frames * 1000) / (t - lastFpsT));
          frames = 0;
          lastFpsT = t;
          $("#fpsState").textContent = `~${clamp(fps,10,144)}`;
          const dot = $("#dotPerf");
          dot.className = "dot" + (fps < 45 ? " warn" : "");
        }
        requestAnimationFrame(fpsLoop);
      }
      requestAnimationFrame(fpsLoop);

      // ============= Text ingestion: extract constraints + intent
      const stop = new Set(("a an the and or but if then else when while to of in on for from by with without into onto over under " +
        "is are was were be been being this that those these it its as at we you i they them he she his her our your their " +
        "can could would should will just not no yes do does did done have has had make made build built").split(/\s+/));

      function tokenize(text){
        return text.toLowerCase()
          .replace(/https?:\/\/\S+/g, " ")
          .replace(/[^a-z0-9\s\-']/g, " ")
          .split(/\s+/)
          .map(s => s.trim())
          .filter(Boolean);
      }

      function topKeywords(text, k=10){
        const toks = tokenize(text).filter(w => w.length>2 && !stop.has(w));
        const freq = new Map();
        for(const w of toks) freq.set(w, (freq.get(w)||0)+1);
        return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,k);
      }

      function guessIntent(text){
        const t = text.toLowerCase();
        const intents = [
          ["performance", /fast|performance|load|fps|lag|bloat|lightweight|budget/],
          ["visual", /flashy|wow|jaw|eye|animation|interactive|alive|motion/],
          ["system-design", /system|architecture|agent|orchestr|pipeline|engine|state/],
          ["explainable", /explain|transparent|builder|math|why|trace/],
          ["product", /invest|client|pitch|convert|narrative|story/],
        ];
        const hits = [];
        for(const [label,re] of intents) if(re.test(t)) hits.push(label);
        return hits.length ? hits : ["general"];
      }

      function extractConstraints(text){
        // Simple heuristic mapping phrases to constraints.
        const t = text.toLowerCase();
        const c = [];

        if(/fast|performance|load|fps|budget|lightweight/.test(t)) c.push("strict performance budget");
        if(/wow|flashy|animation|alive|interactive/.test(t)) c.push("high polish / motion demand");
        if(/explain|transparent|why|trace|builder/.test(t)) c.push("explainability required");
        if(/system|architecture|agent|state|pipeline/.test(t)) c.push("cohesion over widgets");
        if(/no library|vanilla|no frameworks/.test(t)) c.push("no external dependencies");
        return c;
      }

      function objectiveBrief(text){
        const kws = topKeywords(text, 12);
        const intents = guessIntent(text);
        const c = extractConstraints(text);
        return {
          summary:
`BRIEF:
- intent: ${intents.join(" | ")}
- constraints: ${c.length ? c.join(", ") : "none detected"}
- keywords: ${kws.map(([w,n]) => `${w}(${n})`).join(", ")}`,
          kws, intents, c
        };
      }

      // ============= System math: confidence, risk, objective health, weight tuning
      function recomputeDerived(){
        pulseAgent("state");
        // Risk uses uncertainty + telemetry risk + complexity.
        const u = SYSTEM.constraints.uncertainty;
        const cx = SYSTEM.constraints.complexity;
        const tr = SYSTEM.telemetry.risk;
        const risk = clamp(0.45*u + 0.35*tr + 0.20*cx, 0, 1);

        // Confidence is inverse of risk + perf stability.
        const perf = SYSTEM.constraints.perfBudget;
        const conf = clamp(1 - (0.75*risk + 0.25*perf), 0, 1);

        // Objective health favors balance: low risk + reasonable polish.
        const pol = SYSTEM.constraints.polishDemand;
        const health = clamp(0.55*conf + 0.25*(1 - perf) + 0.20*(pol), 0, 1);

        SYSTEM.derived.risk = risk;
        SYSTEM.derived.confidence = conf;
        SYSTEM.derived.objectiveHealth = health;

        // UI chips
        const riskPct = Math.round(risk*100);
        const confPct = Math.round(conf*100);

        $("#riskState").textContent = `${riskPct}%`;
        $("#confState").textContent = `${confPct}%`;

        const dotRisk = $("#dotRisk");
        dotRisk.className = "dot" + (riskPct >= 70 ? " err" : (riskPct >= 45 ? " warn" : ""));
        const dotConf = $("#dotConf");
        dotConf.className = "dot" + (confPct <= 35 ? " err" : (confPct <= 55 ? " warn" : ""));

        $("#objectiveHealth").textContent = `status: ${health >= .72 ? "STRONG" : (health >= .52 ? "OK" : "FRAGILE")}`;

        updateTelemetrySummary();
        updateStateDump();
      }

      function autoTuneWeights(){
        pulseAgent("planner");
        // Tuning rules:
        // - high perfBudget -> speed weight up, polish weight down
        // - high uncertainty/risk -> risk weight up
        // - high polishDemand -> polish weight up (unless perfBudget very strict)
        const p = SYSTEM.constraints.perfBudget;
        const u = SYSTEM.constraints.uncertainty;
        const pol = SYSTEM.constraints.polishDemand;
        const r = SYSTEM.telemetry.risk;

        const impact = 1.10 + 0.40*(1 - p); // more room -> prioritize impact
        const speed  = 0.90 + 0.70*(p);     // stricter budget -> prioritize speed
        const riskW  = 0.75 + 1.00*(0.6*u + 0.4*r);
        const polish = 0.65 + 0.95*(pol) - 0.60*(p);

        SYSTEM.weights.impact = clamp(impact, 0, 2.25);
        SYSTEM.weights.speed  = clamp(speed,  0, 2.25);
        SYSTEM.weights.risk   = clamp(riskW,  0, 2.50);
        SYSTEM.weights.polish = clamp(polish, 0, 2.25);

        $("#wImpact").value = SYSTEM.weights.impact.toFixed(2);
        $("#wSpeed").value  = SYSTEM.weights.speed.toFixed(2);
        $("#wRisk").value   = SYSTEM.weights.risk.toFixed(2);
        $("#wPolish").value = SYSTEM.weights.polish.toFixed(2);

        $("#tuneRules").textContent =
`AUTO-TUNE (simple):
- perfBudget ↑ -> speed weight ↑, polish weight ↓
- uncertainty/risk ↑ -> risk weight ↑
- polishDemand ↑ -> polish weight ↑ (unless perfBudget is strict)

current:
- perfBudget=${fmt(p)}
- uncertainty=${fmt(u)}
- telemetryRisk=${fmt(r)}
- polishDemand=${fmt(pol)}

weights:
- impact=${fmt(SYSTEM.weights.impact)}
- speed=${fmt(SYSTEM.weights.speed)}
- risk=${fmt(SYSTEM.weights.risk)}
- polish=${fmt(SYSTEM.weights.polish)}`;

        trace("planner", `weights tuned (perf=${fmt(p)}, uncert=${fmt(u)}, pol=${fmt(pol)}, trisk=${fmt(r)})`);
      }

      // ============= Decisions
      const defaultOptions = [
        { name:"Unify page under one objective + persistent state", impact: 9, speed: 7, risk: 3, polish: 8 },
        { name:"Add real API feeds (GitHub, RSS) with caching",     impact: 8, speed: 6, risk: 5, polish: 7 },
        { name:"Add heavier visuals (particles/shaders)",          impact: 7, speed: 4, risk: 6, polish: 9 },
        { name:"Polish conversion narrative for non-technical",    impact: 8, speed: 6, risk: 4, polish: 8 },
      ];

      function rowTemplate(opt){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input class="name" value="${esc(opt.name)}" /></td>
          <td><input class="num" type="number" min="0" max="10" step="1" value="${opt.impact}" /></td>
          <td><input class="num" type="number" min="0" max="10" step="1" value="${opt.speed}" /></td>
          <td><input class="num" type="number" min="0" max="10" step="1" value="${opt.risk}" /></td>
          <td><input class="num" type="number" min="0" max="10" step="1" value="${opt.polish}" /></td>
        `;
        return tr;
      }

      function loadDecision(opts){
        const body = $("#optBody");
        body.innerHTML = "";
        for(const o of opts) body.appendChild(rowTemplate(o));
      }

      function getWeights(){
        return {
          impact: parseFloat($("#wImpact").value || "0") || 0,
          speed:  parseFloat($("#wSpeed").value  || "0") || 0,
          risk:   parseFloat($("#wRisk").value   || "0") || 0,
          polish: parseFloat($("#wPolish").value || "0") || 0,
        };
function getWeights(){
        return {
          impact: parseFloat($("#wImpact").value || "0") || 0,
          speed:  parseFloat($("#wSpeed").value  || "0") || 0,
          risk:   parseFloat($("#wRisk").value   || "0") || 0,
          polish: parseFloat($("#wPolish").value || "0") || 0,
        };
      }

      function readOptions(){
        const rows = Array.from($("#optBody").querySelectorAll("tr"));
        return rows.map(r => {
          const inputs = Array.from(r.querySelectorAll("input"));
          return {
            name: inputs[0].value.trim() || "Untitled",
            impact: clamp(parseFloat(inputs[1].value||"0")||0, 0, 10),
            speed:  clamp(parseFloat(inputs[2].value||"0")||0, 0, 10),
            risk:   clamp(parseFloat(inputs[3].value||"0")||0, 0, 10),
            polish: clamp(parseFloat(inputs[4].value||"0")||0, 0, 10),
          };
        });
      }

      function scoreOption(o, w){
        // Risk is inverted (lower risk better). Normalize inputs to 0..1
        const I = o.impact / 10;
        const S = o.speed  / 10;
        const R = 1 - (o.risk / 10);
        const P = o.polish / 10;

        // State modifiers: higher uncertainty penalizes impact/polish a bit; strict perf penalizes polish more.
        const u = SYSTEM.constraints.uncertainty;
        const perf = SYSTEM.constraints.perfBudget;
        const statePenalty = clamp(0.10*u + 0.10*perf, 0, 0.25);
        const polishPenalty = clamp(0.20*perf, 0, 0.30);

        const iEff = clamp(I * (1 - statePenalty), 0, 1);
        const sEff = clamp(S * (1 - 0.08*u), 0, 1);
        const rEff = clamp(R * (1 - 0.10*SYSTEM.telemetry.risk), 0, 1);
        const pEff = clamp(P * (1 - statePenalty - polishPenalty), 0, 1);

        const raw = (w.impact*iEff) + (w.speed*sEff) + (w.risk*rEff) + (w.polish*pEff);
        const denom = Math.max(0.001, w.impact + w.speed + w.risk + w.polish);
        const score = raw / denom;

        return { score, parts:{ iEff,sEff,rEff,pEff }, raw, denom };
      }

      function recalcDecisions(reason="manual"){
        pulseAgent("scorer");
        const w = getWeights();
        SYSTEM.weights = { ...w };

        const opts = readOptions();
        const scored = opts.map(o => {
          const s = scoreOption(o,w);
          return { ...o, ...s };
        }).sort((a,b) => b.score - a.score);

        const lines = [];
        lines.push(`RANKING (weighted, state-aware) — reason: ${reason}`);
        lines.push(`state: uncertainty=${fmt(SYSTEM.constraints.uncertainty)} perfBudget=${fmt(SYSTEM.constraints.perfBudget)} telemetryRisk=${fmt(SYSTEM.telemetry.risk)}`);
        lines.push(`weights: impact=${fmt(w.impact)} speed=${fmt(w.speed)} risk=${fmt(w.risk)} polish=${fmt(w.polish)}`);
        lines.push("");
        scored.forEach((o, idx) => {
          const sPct = (o.score*100).toFixed(1);
          lines.push(`${String(idx+1).padStart(2,"0")}. ${o.name}`);
          lines.push(`    score=${sPct}% | impact=${o.impact} speed=${o.speed} risk=${o.risk} polish=${o.polish}`);
          if(SYSTEM.mode === "builder"){
            lines.push(`    eff: i=${fmt(o.parts.iEff)} s=${fmt(o.parts.sEff)} r=${fmt(o.parts.rEff)} p=${fmt(o.parts.pEff)}`);
          }
        });

        $("#decisionOut").textContent = lines.join("\n");
        $("#rankBadge").textContent = `top: ${scored[0]?.name ? scored[0].name.slice(0,22) + (scored[0].name.length>22?"…":"") : "—"}`;

        // Derive confidence based on spread between #1 and #2 and system confidence
        const top = scored[0]?.score ?? 0;
        const second = scored[1]?.score ?? top;
        const spread = clamp(top - second, 0, 1);
        const conf = clamp(0.55*SYSTEM.derived.confidence + 0.45*clamp(spread*3, 0, 1), 0, 1);
        SYSTEM.derived.confidence = conf;

        recomputeDerived();
        trace("scorer", `decisions recalculated (${reason}), spread=${fmt(spread)}, conf=${fmt(conf)}`);
      }

      // ============= Objective + signals UI wiring
      function applyObjective(text){
        pulseAgent("intake");
        SYSTEM.objective = text.trim();
        const brief = objectiveBrief(SYSTEM.objective);

        SYSTEM.signals.keywords = brief.kws.map(([w])=>w);
        SYSTEM.signals.intents = brief.intents;
        SYSTEM.signals.constraints = brief.c;

        $("#objectiveOut").textContent = brief.summary;

        // Heuristic: if objective mentions speed/performance, increase perf budget strictness a bit
        const t = SYSTEM.objective.toLowerCase();
        if(/fast|performance|fps|load|lightweight|budget/.test(t)) SYSTEM.constraints.perfBudget = clamp(SYSTEM.constraints.perfBudget + 0.06, 0, 1);
        if(/wow|flashy|alive|animation|interactive|motion/.test(t)) SYSTEM.constraints.polishDemand = clamp(SYSTEM.constraints.polishDemand + 0.06, 0, 1);
        if(/explain|transparent|trace|why|builder/.test(t)) SYSTEM.constraints.uncertainty = clamp(SYSTEM.constraints.uncertainty - 0.04, 0, 1);

        syncConstraintSliders();
        autoTuneWeights();
        recomputeDerived();
        recalcDecisions("objective");
        trace("intake", `objective applied, intents=${brief.intents.join("|")}`);
      }

      function ingestSignals(text){
        pulseAgent("intake");
        const brief = objectiveBrief(text);
        const mergedKws = new Set([...(SYSTEM.signals.keywords||[]), ...brief.kws.map(([w])=>w)]);
        const mergedIntents = new Set([...(SYSTEM.signals.intents||[]), ...brief.intents]);
        const mergedCons = new Set([...(SYSTEM.signals.constraints||[]), ...brief.c]);

        SYSTEM.signals.keywords = Array.from(mergedKws).slice(0,18);
        SYSTEM.signals.intents = Array.from(mergedIntents).slice(0,10);
        SYSTEM.signals.constraints = Array.from(mergedCons).slice(0,14);

        $("#signalOut").textContent =
`INGESTED:
- intents: ${SYSTEM.signals.intents.join(" | ")}
- constraints: ${SYSTEM.signals.constraints.length ? SYSTEM.signals.constraints.join(", ") : "—"}
- keywords: ${SYSTEM.signals.keywords.join(", ")}`;

        // Nudge state based on detected signals
        const lower = text.toLowerCase();
        if(/fast|performance|fps|budget/.test(lower)) SYSTEM.constraints.perfBudget = clamp(SYSTEM.constraints.perfBudget + 0.05, 0, 1);
        if(/polish|wow|flashy|alive|animation|motion/.test(lower)) SYSTEM.constraints.polishDemand = clamp(SYSTEM.constraints.polishDemand + 0.05, 0, 1);
        if(/risky|unknown|uncertain|ambiguous/.test(lower)) SYSTEM.constraints.uncertainty = clamp(SYSTEM.constraints.uncertainty + 0.04, 0, 1);
        if(/complex|big|massive|huge/.test(lower)) SYSTEM.constraints.complexity = clamp(SYSTEM.constraints.complexity + 0.04, 0, 1);

        syncConstraintSliders();
        autoTuneWeights();
        recomputeDerived();
        recalcDecisions("signals");
        trace("intake", `signals ingested, kws=${brief.kws.slice(0,6).map(x=>x[0]).join(",")}`);
      }

      function syncConstraintSliders(){
        $("#sComplex").value = String(Math.round(SYSTEM.constraints.complexity*100));
        $("#sUncert").value  = String(Math.round(SYSTEM.constraints.uncertainty*100));
        $("#sPerf").value    = String(Math.round(SYSTEM.constraints.perfBudget*100));
        $("#sPolish").value  = String(Math.round(SYSTEM.constraints.polishDemand*100));
        $("#constraintReadout").textContent =
          `cx=${Math.round(SYSTEM.constraints.complexity*100)} u=${Math.round(SYSTEM.constraints.uncertainty*100)} perf=${Math.round(SYSTEM.constraints.perfBudget*100)} pol=${Math.round(SYSTEM.constraints.polishDemand*100)}`;
      }

      function readConstraintSliders(){
        SYSTEM.constraints.complexity   = clamp(parseFloat($("#sComplex").value||"0")/100, 0, 1);
        SYSTEM.constraints.uncertainty  = clamp(parseFloat($("#sUncert").value||"0")/100, 0, 1);
        SYSTEM.constraints.perfBudget   = clamp(parseFloat($("#sPerf").value||"0")/100, 0, 1);
        SYSTEM.constraints.polishDemand = clamp(parseFloat($("#sPolish").value||"0")/100, 0, 1);
        syncConstraintSliders();
        autoTuneWeights();
        recomputeDerived();
        recalcDecisions("constraints");
        trace("state", "constraints changed");
      }

      // slider listeners
      ["sComplex","sUncert","sPerf","sPolish"].forEach(id => {
        $("#"+id).addEventListener("input", readConstraintSliders);
      });

      $("#btnApplyObjective").addEventListener("click", () => applyObjective($("#objectiveIn").value));
      $("#btnObjectiveSample").addEventListener("click", () => {
        $("#objectiveIn").value = "Build a jaw-dropping but fast single-page system demo. It must stay coherent, show explainable decisions, and feel alive without external libraries.";
        applyObjective($("#objectiveIn").value);
      });

      $("#btnIngest").addEventListener("click", () => ingestSignals($("#signalIn").value));
      $("#btnSignalSample").addEventListener("click", () => {
        $("#signalIn").value = "Keep load time low. Use canvas visuals. Make decisions react to telemetry. Show the why in builder mode. Make it feel like an operating system, not a widget set.";
        ingestSignals($("#signalIn").value);
      });
      $("#btnClearSignals").addEventListener("click", () => {
        $("#signalIn").value = "";
        $("#signalOut").textContent = "Extracted constraints will appear here.";
        SYSTEM.signals = { keywords:[], intents:[], constraints:[] };
        trace("intake", "signals cleared");
      });

      $("#signalIn").addEventListener("keydown", (e) => {
        if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
          e.preventDefault();
          ingestSignals($("#signalIn").value);
        }
      });

      $("#btnNudge").addEventListener("click", () => {
        pulseAgent("state");
        // Small pseudo-random drift that looks alive (bounded).
        const r = () => (Math.random()*2-1);
        SYSTEM.constraints.complexity   = clamp(SYSTEM.constraints.complexity   + r()*0.02, 0, 1);
        SYSTEM.constraints.uncertainty  = clamp(SYSTEM.constraints.uncertainty  + r()*0.02, 0, 1);
        SYSTEM.constraints.perfBudget   = clamp(SYSTEM.constraints.perfBudget   + r()*0.02, 0, 1);
        SYSTEM.constraints.polishDemand = clamp(SYSTEM.constraints.polishDemand + r()*0.02, 0, 1);
        syncConstraintSliders();
        autoTuneWeights();
        recomputeDerived();
        recalcDecisions("nudge");
        trace("state","state nudged");
      });

      // Decision buttons + weight edits
      $("#btnAddOpt").addEventListener("click", () => {
        $("#optBody").appendChild(rowTemplate({ name:"New option", impact:7, speed:7, risk:5, polish:7 }));
        trace("scorer", "option added");
      });
      $("#btnRecalc").addEventListener("click", () => recalcDecisions("manual"));
      $("#btnResetDecision").addEventListener("click", () => {
        loadDecision(defaultOptions);
        recalcDecisions("reset");
        trace("scorer","options reset");
      });
      ["wImpact","wSpeed","wRisk","wPolish"].forEach(id => {
        $("#"+id).addEventListener("input", () => {
          SYSTEM.weights = getWeights();
          recalcDecisions("weights");
        });
      });

      // ============= Telemetry stream + sparklines
      const LOG_MAX = 260;
      let streamOn = true;
      let streamTimer = null;
      let lastEvtT = now();
      let evtInLastSec = 0;

      const sparkCanvases = [$("#sparkA"), $("#sparkB"), $("#sparkC")];
      const sparkCtx = sparkCanvases.map(c => c.getContext("2d", { alpha:true }));
      let sparkW=0, sparkH=0;
      const sparkLen = 110;
      const sparkA = new Float32Array(sparkLen); // load
      const sparkB = new Float32Array(sparkLen); // momentum
      const sparkC = new Float32Array(sparkLen); // risk
      let sIdx=0;

      function resizeSparks(){
        sparkCanvases.forEach((c,i)=>{
          const r = resizeCanvas(c, sparkCtx[i]);
          sparkW = r.w; sparkH = r.h;
        });
      }
      resizeSparks();
      window.addEventListener("resize", resizeSparks);

      function pushSpark(a,b,c){
        sparkA[sIdx] = a;
        sparkB[sIdx] = b;
        sparkC[sIdx] = c;
        sIdx = (sIdx + 1) % sparkLen;
      }

      function drawSpark(ctx, arr, colorA, colorB){
        ctx.clearRect(0,0,sparkW,sparkH);

        // grid
        ctx.globalAlpha = 0.22;
        ctx.strokeStyle = getComputedStyle(root).getPropertyValue("--stroke");
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let x=0;x<=sparkW;x+=sparkW/6){ ctx.moveTo(x,0); ctx.lineTo(x,sparkH); }
        for(let y=0;y<=sparkH;y+=sparkH/3){ ctx.moveTo(0,y); ctx.lineTo(sparkW,y); }
        ctx.stroke();
        ctx.globalAlpha = 1;

        const g = ctx.createLinearGradient(0,0,sparkW,0);
        g.addColorStop(0, colorA);
        g.addColorStop(1, colorB);
        ctx.strokeStyle = g;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for(let i=0;i<sparkLen;i++){
          const idx = (sIdx + i) % sparkLen;
          const v = clamp(arr[idx], 0, 1);
          const x = (i/(sparkLen-1))*sparkW;
          const y = sparkH - (v*(sparkH-10)) - 5;
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }

      function renderSparks(){
        drawSpark(sparkCtx[0], sparkA, "rgba(124,58,237,.85)", "rgba(6,182,212,.85)");
        drawSpark(sparkCtx[1], sparkB, "rgba(6,182,212,.85)", "rgba(34,197,94,.85)");
        drawSpark(sparkCtx[2], sparkC, "rgba(249,115,22,.85)", "rgba(239,68,68,.85)");
      }

      function appendLog(line){
        const logEl = $("#log");
        const cur = logEl.textContent.split("\n").filter(Boolean);
        cur.push(line);
        logEl.textContent = cur.slice(-LOG_MAX).join("\n");
        logEl.scrollTop = logEl.scrollHeight;
      }

      function updateTelemetrySummary(){
        const t = SYSTEM.telemetry;
        $("#telemetrySummary").textContent =
`TELEMETRY SUMMARY:
- load=${fmt(t.load)} • momentum=${fmt(t.momentum)} • risk=${fmt(t.risk)} • tag=${t.lastTag}
- constraints: perfBudget=${fmt(SYSTEM.constraints.perfBudget)} uncertainty=${fmt(SYSTEM.constraints.uncertainty)}
- derived: confidence=${fmt(SYSTEM.derived.confidence)} objectiveHealth=${fmt(SYSTEM.derived.objectiveHealth)}`;
      }

      function telemetryTick(step=false){
        pulseAgent("state", 280);

        // Coupled dynamics. Strict perf budget tends to lower load; complexity increases load.
        const cx = SYSTEM.constraints.complexity;
        const perf = SYSTEM.constraints.perfBudget;
        const pol = SYSTEM.constraints.polishDemand;
        const u = SYSTEM.constraints.uncertainty;

        // random noise
        const n = () => (Math.random()*2-1);

        // load responds to complexity and perf strictness
        let load = SYSTEM.telemetry.load;
        load += 0.06*(cx - 0.4) - 0.05*(perf - 0.4) + 0.05*n();
        load = clamp(load, 0, 1);

        // momentum responds to confidence and polish demand (more polish means more "work")
        let momentum = SYSTEM.telemetry.momentum;
        momentum += 0.06*(SYSTEM.derived.confidence - 0.5) - 0.04*(pol - 0.5) + 0.05*n();
        momentum = clamp(momentum, 0, 1);

        // telemetry risk responds to uncertainty + load spikes
        let trisk = SYSTEM.telemetry.risk;
        trisk += 0.07*(u - 0.4) + 0.06*(load - 0.5) + 0.04*n();
        trisk = clamp(trisk, 0, 1);

        SYSTEM.telemetry.load = load;
        SYSTEM.telemetry.momentum = momentum;
        SYSTEM.telemetry.risk = trisk;

        const tag = (trisk > 0.72) ? "RISK" : (load > 0.72) ? "LOAD" : (momentum > 0.70) ? "MOMENTUM" : "OK";
        SYSTEM.telemetry.lastTag = tag;

        const stamp = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        appendLog(`[${stamp}] ${tag} load=${Math.round(load*100)}% mom=${Math.round(momentum*100)}% risk=${Math.round(trisk*100)}%`);

        pushSpark(load, momentum, trisk);
        renderSparks();

        // activity waveform (0..1)
        pushActivity(0.30 + 0.35*momentum + 0.25*(1-trisk) + 0.10*n());
        drawActivity();

        // event rate calc
        evtInLastSec++;
        const tNow = now();
        if(tNow - lastEvtT > 1000){
          $("#evtRate").textContent = `rate: ${evtInLastSec}/s`;
          evtInLastSec = 0;
          lastEvtT = tNow;
        }

        // A telemetry tick changes derived + decisions
        recomputeDerived();
        autoTuneWeights();
        recalcDecisions(step ? "telemetry(step)" : "telemetry");

        trace("state", `telemetry tick tag=${tag} load=${fmt(load)} mom=${fmt(momentum)} risk=${fmt(trisk)}`);
      }

      function startStream(){
        if(streamTimer) return;
        streamOn = true;
        $("#streamBadge").textContent = "streaming";
        $("#btnPause").textContent = "Pause";
        streamTimer = setInterval(() => telemetryTick(false), 850);
        trace("state","stream started");
      }
      function stopStream(){
        if(!streamTimer) return;
        clearInterval(streamTimer);
        streamTimer = null;
        streamOn = false;
        $("#streamBadge").textContent = "paused";
        $("#btnPause").textContent = "Resume";
        trace("state","stream paused");
      }

      $("#btnPause").addEventListener("click", () => (streamOn ? stopStream() : startStream()));
      $("#btnStep").addEventListener("click", () => telemetryTick(true));
      $("#btnResetStream").addEventListener("click", () => {
        $("#log").textContent = "";
        for(let i=0;i<sparkLen;i++){ sparkA[i]=0; sparkB[i]=0; sparkC[i]=0; }
        SYSTEM.telemetry = { load:0.40, momentum:0.55, risk:0.35, lastTag:"OK" };
        pushSpark(SYSTEM.telemetry.load, SYSTEM.telemetry.momentum, SYSTEM.telemetry.risk);
        renderSparks();
        updateTelemetrySummary();
        recomputeDerived();
        recalcDecisions("stream reset");
        trace("state","stream reset");
      });

      // Telemetry collapsible label
      const telemetryDetails = $("#telemetryDetails");
      telemetryDetails.addEventListener("toggle", () => {
        $("#telemetryChev").textContent = telemetryDetails.open ? "collapse" : "expand";
      });

      // ============= Force graph (agents + nodes)
      const graphCanvas = $("#graphCanvas");
      const gctx = graphCanvas.getContext("2d", { alpha:true });
      let gW=0, gH=0;
      let frozen = false;

      const graph = {
        nodes: [],
        links: [],
        drag: { on:false, id:null, ox:0, oy:0 },
        running: true,
        center: { x:0, y:0 }
      };

      function reseedGraph(){
        pulseAgent("visual");
        const r = resizeCanvas(graphCanvas, gctx);
        gW=r.w; gH=r.h;
        graph.center.x = gW/2; graph.center.y = gH/2;

        // Nodes: agents + a few "signals" + "decisions" nodes
        const base = [
          ...AGENTS.map(a => ({ id:a.id, label:a.name, type:"agent" })),
          { id:"objective", label:"Objective", type:"core" },
          { id:"signals", label:"Signals", type:"core" },
          { id:"state", label:"State", type:"core" },
          { id:"decisions", label:"Decisions", type:"core" },
          { id:"telemetry", label:"Telemetry", type:"core" },
          { id:"render", label:"Render", type:"core" },
        ];

        graph.nodes = base.map((n, i) => ({
          ...n,
          x: graph.center.x + (Math.random()*2-1)*gW*0.22,
          y: graph.center.y + (Math.random()*2-1)*gH*0.22,
          vx: (Math.random()*2-1)*0.3,
          vy: (Math.random()*2-1)*0.3,
          r: n.type==="agent" ? 14 : 16
        }));

        const idToIdx = new Map(graph.nodes.map((n,i)=>[n.id,i]));

        function link(a,b,w=1){
          graph.links.push({ a:idToIdx.get(a), b:idToIdx.get(b), w });
        }

        graph.links = [];
        link("objective","signals",1.2);
        link("signals","state",1.2);
        link("state","decisions",1.2);
        link("telemetry","state",1.1);
        link("render","state",0.9);
        link("render","decisions",0.9);

        // agent links
        link("orchestrator","objective",1.1);
        link("orchestrator","state",1.1);
        link("orchestrator","scorer",1.0);
        link("orchestrator","planner",1.0);
        link("intake","signals",1.0);
        link("state","telemetry",1.0);
        link("planner","decisions",1.0);
        link("scorer","decisions",1.0);
        link("visual","render",1.0);
        link("visual","orchestrator",0.8);

        $("#nodeCount").textContent = String(graph.nodes.length);
        $("#linkCount").textContent = String(graph.links.length);
        $("#graphState").textContent = frozen ? "frozen" : "running";

        trace("visual","graph reseeded");
      }

      function drawGraph(){
        gctx.clearRect(0,0,gW,gH);

        // faint grid
        gctx.globalAlpha = 0.16;
        gctx.strokeStyle = getComputedStyle(root).getPropertyValue("--stroke");
        gctx.lineWidth = 1;
        gctx.beginPath();
        for(let x=0;x<=gW;x+=gW/10){ gctx.moveTo(x,0); gctx.lineTo(x,gH); }
        for(let y=0;y<=gH;y+=gH/6){ gctx.moveTo(0,y); gctx.lineTo(gW,y); }
        gctx.stroke();
        gctx.globalAlpha = 1;

        // links
        gctx.lineWidth = 1.5;
        for(const L of graph.links){
          const A = graph.nodes[L.a], B = graph.nodes[L.b];
          const grad = gctx.createLinearGradient(A.x,A.y,B.x,B.y);
          grad.addColorStop(0,"rgba(124,58,237,.45)");
          grad.addColorStop(0.5,"rgba(6,182,212,.35)");
          grad.addColorStop(1,"rgba(34,197,94,.32)");
          gctx.strokeStyle = grad;
          gctx.beginPath();
          gctx.moveTo(A.x,A.y);
          gctx.lineTo(B.x,B.y);
          gctx.stroke();
        }

        // nodes
        for(const N of graph.nodes){
          const isAgent = (N.type === "agent");
          const glow = isAgent ? 0.18 : 0.14;

          gctx.beginPath();
          gctx.fillStyle = isAgent ? "rgba(6,182,212,.20)" : "rgba(255,255,255,.10)";
          gctx.arc(N.x, N.y, N.r+8, 0, Math.PI*2);
          gctx.fill();

          gctx.beginPath();
          gctx.fillStyle = isAgent ? "rgba(6,182,212,.75)" : "rgba(234,240,255,.55)";
          gctx.arc(N.x, N.y, N.r, 0, Math.PI*2);
          gctx.fill();

          gctx.beginPath();
          gctx.globalAlpha = 1;
          gctx.fillStyle = "rgba(0,0,0,.35)";
          gctx.arc(N.x-2, N.y-2, N.r, 0, Math.PI*2);
          gctx.fill();

          gctx.globalAlpha = 1;
          gctx.fillStyle = "rgba(255,255,255,.92)";
          gctx.font = "12px " + getComputedStyle(root).getPropertyValue("--sans");
          gctx.textAlign = "center";
          gctx.textBaseline = "top";
          gctx.fillText(N.label, N.x, N.y + N.r + 6);

          // subtle pulse for active agents
          const agentEl = $(`.agent[data-agent="${N.id}"]`);
          if(agentEl && agentEl.classList.contains("active")){
            gctx.globalAlpha = 0.65;
            gctx.strokeStyle = "rgba(6,182,212,.9)";
            gctx.lineWidth = 2;
            gctx.beginPath();
            gctx.arc(N.x,N.y,N.r+10,0,Math.PI*2);
            gctx.stroke();
            gctx.globalAlpha = 1;
          }
        }
      }

      function stepGraph(){
        if(!gW || !gH) return;

        if(!frozen){
          // physics
          const cx = graph.center.x, cy = graph.center.y;
          const repel = 1800;
          const linkK = 0.010;
          const damp = 0.92;

          // repulsion
          for(let i=0;i<graph.nodes.length;i++){
            const A = graph.nodes[i];
            for(let j=i+1;j<graph.nodes.length;j++){
              const B = graph.nodes[j];
              const dx = A.x - B.x;
              const dy = A.y - B.y;
              const d2 = dx*dx + dy*dy + 0.001;
              const f = repel / d2;
              const fx = f*dx;
              const fy = f*dy;
              A.vx += fx*0.0008; A.vy += fy*0.0008;
              B.vx -= fx*0.0008; B.vy -= fy*0.0008;
            }
          }

          // springs
          for(const L of graph.links){
            const A = graph.nodes[L.a], B = graph.nodes[L.b];
            const dx = B.x - A.x;
            const dy = B.y - A.y;
            const dist = Math.sqrt(dx*dx + dy*dy) + 0.001;
            const target = 115 / L.w;
            const diff = (dist - target);
            const fx = (dx/dist) * diff * linkK;
            const fy = (dy/dist) * diff * linkK;
            A.vx += fx; A.vy += fy;
            B.vx -= fx; B.vy -= fy;
          }

          // center gravity + integrate
          for(const N of graph.nodes){
            // drag lock
            if(graph.drag.on && graph.drag.id === N.id) continue;

            N.vx += (cx - N.x) * 0.0009;
            N.vy += (cy - N.y) * 0.0009;

            N.vx *= damp; N.vy *= damp;
            N.x += N.vx; N.y += N.vy;

            // bounds
            const pad = 34;
            if(N.x < pad){ N.x=pad; N.vx *= -0.5; }
            if(N.x > gW-pad){ N.x=gW-pad; N.vx *= -0.5; }
            if(N.y < pad){ N.y=pad; N.vy *= -0.5; }
            if(N.y > gH-pad){ N.y=gH-pad; N.vy *= -0.5; }
          }
        }

        drawGraph();
        requestAnimationFrame(stepGraph);
      }

      function graphHit(x,y){
        // iterate backwards to prefer later nodes
        for(let i=graph.nodes.length-1;i>=0;i--){
          const N = graph.nodes[i];
          const dx = x - N.x;
          const dy = y - N.y;
          if(dx*dx + dy*dy <= (N.r+8)*(N.r+8)) return N;
        }
        return null;
      }

      function graphPointerPos(e){
        const rect = graphCanvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        return {x,y};
      }

      graphCanvas.addEventListener("pointerdown", (e) => {
        const {x,y} = graphPointerPos(e);
        const hit = graphHit(x,y);
        if(!hit) return;
        graphCanvas.setPointerCapture(e.pointerId);
        graph.drag.on = true;
        graph.drag.id = hit.id;
        graph.drag.ox = x - hit.x;
        graph.drag.oy = y - hit.y;
        // show agent brief if agent node
        if(agentIndex.has(hit.id)) showAgent(hit.id);
        else $("#agentBrief").textContent = `${hit.label}\n—\nThis is a structural node in the system graph.`;
        trace("visual", `graph drag start: ${hit.id}`);
      });

      graphCanvas.addEventListener("pointermove", (e) => {
        if(!graph.drag.on) return;
        const {x,y} = graphPointerPos(e);
        const id = graph.drag.id;
        const N = graph.nodes.find(n => n.id === id);
        if(!N) return;
        N.x = x - graph.drag.ox;
        N.y = y - graph.drag.oy;
      });

      function endDrag(){
        if(!graph.drag.on) return;
        trace("visual", `graph drag end: ${graph.drag.id}`);
        graph.drag.on = false;
        graph.drag.id = null;
      }
      graphCanvas.addEventListener("pointerup", endDrag);
      graphCanvas.addEventListener("pointercancel", endDrag);

      $("#btnReseed").addEventListener("click", reseedGraph);
      $("#btnCenter").addEventListener("click", () => {
        graph.center.x = gW/2; graph.center.y = gH/2;
        for(const N of graph.nodes){
          N.x = graph.center.x + (Math.random()*2-1)*gW*0.12;
          N.y = graph.center.y + (Math.random()*2-1)*gH*0.12;
          N.vx *= 0.2; N.vy *= 0.2;
        }
        trace("visual","graph centered");
      });
      $("#btnFreeze").addEventListener("click", () => {
        frozen = !frozen;
        $("#btnFreeze").textContent = frozen ? "Unfreeze" : "Freeze";
        $("#graphState").textContent = frozen ? "frozen" : "running";
        trace("visual", frozen ? "graph frozen" : "graph unfrozen");
      });

      // ============= Command palette
      const modal = $("#modal");
      const cmdSearch = $("#cmdSearch");
      const cmdList = $("#cmdList");

      const COMMANDS = [
        { t:"Run Cycle", d:"Run full system cycle (objective→telemetry→decisions→agents)", k:"R", fn: () => runCycle() },
        { t:"Toggle Mode", d:"Viewer ↔ Builder", k:"M", fn: () => toggleMode() },
        { t:"Toggle Theme", d:"Dark ↔ Ice", k:"T", fn: () => toggleTheme() },
        { t:"Toggle Focus", d:"Hide aurora for maximum readability", k:"F", fn: () => toggleFocus() },
        { t:"Jump: Signals", d:"Scroll to Signals section", k:"", fn: () => $("#signals").scrollIntoView({behavior:"smooth"}) },
        { t:"Jump: Decisions", d:"Scroll to Decisions section", k:"", fn: () => $("#decisions").scrollIntoView({behavior:"smooth"}) },
        { t:"Jump: Agents", d:"Scroll to Agents section", k:"", fn: () => $("#agents").scrollIntoView({behavior:"smooth"}) },
        { t:"Jump: Telemetry", d:"Scroll to Telemetry section", k:"", fn: () => $("#telemetry").scrollIntoView({behavior:"smooth"}) },
        { t:"Reseed Graph", d:"Rebuild and randomize the architecture graph", k:"R", fn: () => reseedGraph() },
        { t:"Reset System", d:"Return everything to defaults", k:"", fn: () => resetAll() },
      ];

      function openPalette(){
        modal.classList.add("on");
        modal.setAttribute("aria-hidden","false");
        cmdSearch.value = "";
        renderCommands("");
        setTimeout(()=>cmdSearch.focus(), 20);
      }
      function closePalette(){
        modal.classList.remove("on");
        modal.setAttribute("aria-hidden","true");
      }

      function renderCommands(filter){
        const q = filter.trim().toLowerCase();
        const items = COMMANDS.filter(c => !q || (c.t.toLowerCase().includes(q) || c.d.toLowerCase().includes(q)));
        cmdList.innerHTML = "";
        for(const c of items){
          const row = document.createElement("div");
          row.className = "cmd";
          row.innerHTML = `
            <div class="left">
              <div class="t">${esc(c.t)}</div>
              <div class="d">${esc(c.d)}</div>
            </div>
            <div class="right">
              ${c.k ? `<span class="kbd">${esc(c.k)}</span>` : ``}
              <span class="kbd">Enter</span>
            </div>
          `;
          row.addEventListener("click", () => { closePalette(); c.fn(); });
          cmdList.appendChild(row);
        }
      }

      $("#btnPalette").addEventListener("click", openPalette);
      $("#btnClose").addEventListener("click", closePalette);
      modal.addEventListener("click", (e) => { if(e.target === modal) closePalette(); });
      cmdSearch.addEventListener("input", () => renderCommands(cmdSearch.value));
      cmdSearch.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          const first = cmdList.querySelector(".cmd");
          if(first){ first.click(); }
        }
      });

      // ============= System reset + state dump
      function resetAll(){
        pulseAgent("orchestrator", 520);

        SYSTEM.objective = "";
        SYSTEM.constraints = { complexity: 0.28, uncertainty: 0.34, perfBudget: 0.40, polishDemand: 0.62 };
        SYSTEM.weights = { impact: 1.25, speed: 1.00, risk: 0.90, polish: 0.85 };
        SYSTEM.derived = { confidence: 0.0, risk: 0.0, objectiveHealth: 0.0 };
        SYSTEM.signals = { keywords: [], intents: [], constraints: [] };
        SYSTEM.telemetry = { load:0.40, momentum:0.55, risk:0.35, lastTag:"OK" };
        SYSTEM.counters.events = 0;

        $("#evtCount").textContent = "0";
        $("#evtLast").textContent = "—";
        $("#traceLog").textContent = "";

        $("#objectiveIn").value = "Build a next-level single-page demo that proves system design: fast, coherent, visually strong, and transparent about tradeoffs.";
        $("#objectiveOut").textContent = "System brief will appear here.";
        $("#signalIn").value = "Make it feel alive. Keep it fast. Show decision-making that reacts to state changes. Keep it explainable in Builder Mode.";
        $("#signalOut").textContent = "Extracted constraints will appear here.";

        $("#log").textContent = "";
        $("#telemetrySummary").textContent = "—";
        $("#evtRate").textContent = "rate: —";

        loadDecision(defaultOptions);

        syncConstraintSliders();
        $("#wImpact").value = SYSTEM.weights.impact.toFixed(2);
        $("#wSpeed").value  = SYSTEM.weights.speed.toFixed(2);
        $("#wRisk").value   = SYSTEM.weights.risk.toFixed(2);
        $("#wPolish").value = SYSTEM.weights.polish.toFixed(2);

        // sparks
        for(let i=0;i<sparkLen;i++){ sparkA[i]=0; sparkB[i]=0; sparkC[i]=0; }
        pushSpark(SYSTEM.telemetry.load, SYSTEM.telemetry.momentum, SYSTEM.telemetry.risk);
        renderSparks();

        // activity buffer
        for(let i=0;i<activity.length;i++) activity[i] = 0.45 + (Math.random()*0.08);
        drawActivity();

        recomputeDerived();
        autoTuneWeights();
        recalcDecisions("reset");
        reseedGraph();

        trace("orchestrator","system reset complete");
      }

      function updateStateDump(){
        const dump = {
          objective: SYSTEM.objective || "(not applied)",
          constraints: SYSTEM.constraints,
          weights: SYSTEM.weights,
          derived: SYSTEM.derived,
          signals: SYSTEM.signals,
          telemetry: SYSTEM.telemetry,
          counters: SYSTEM.counters,
          mode: SYSTEM.mode,
        };
        $("#stateDump").textContent = JSON.stringify(dump, null, 2);
      }

      // ============= Run Cycle (orchestrated)
      function setCycleState(txt, cls=""){
        $("#cycleState").textContent = txt;
        const dot = $("#dotRun");
        dot.className = "dot" + (cls ? ` ${cls}` : "");
      }

      async function runCycle(){
        pulseAgent("orchestrator", 650);
        setCycleState("RUNNING");
        trace("orchestrator","cycle started");

        // 1) Apply objective if not yet applied (or re-apply)
        const obj = $("#objectiveIn").value.trim();
        if(obj) applyObjective(obj);

        // 2) Ingest signals
        const sig = $("#signalIn").value.trim();
        if(sig) ingestSignals(sig);

        // 3) One telemetry tick (simulate internal update)
        telemetryTick(true);

        // 4) Recompute & rank
        autoTuneWeights();
        recomputeDerived();
        recalcDecisions("cycle");

        // 5) Pulse key agents for visibility
        pulseAgent("planner", 520);
        pulseAgent("scorer", 520);
        pulseAgent("visual", 520);

        // visual activity spike
        pushActivity(0.92); drawActivity();

        setCycleState("DONE");
        trace("orchestrator","cycle completed");
        setTimeout(()=>setCycleState("READY"), 900);
      }

      $("#btnRunMission").addEventListener("click", runCycle);

      // ============= Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        const k = e.key.toLowerCase();

        // ESC closes palette
        if(k === "escape" && modal.classList.contains("on")){
          e.preventDefault();
          closePalette();
          return;
        }

        // Ctrl/Cmd+K opens palette
        if((e.ctrlKey || e.metaKey) && k === "k"){
          e.preventDefault();
          if(modal.classList.contains("on")) closePalette(); else openPalette();
          return;
        }

        // If typing in an input/textarea, ignore single-key shortcuts
        const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
        if(tag === "input" || tag === "textarea") return;

        if(k === "m"){ e.preventDefault(); toggleMode(); }
        if(k === "t"){ e.preventDefault(); toggleTheme(); }
        if(k === "f"){ e.preventDefault(); toggleFocus(); }
        if(k === "r"){
          e.preventDefault();
          // Context: if agents section visible, reseed graph; otherwise run cycle
          const agentsRect = $("#agents").getBoundingClientRect();
          const inAgents = agentsRect.top < window.innerHeight*0.6 && agentsRect.bottom > window.innerHeight*0.3;
          if(inAgents) reseedGraph(); else runCycle();
        }
      });

      // ============= Buttons already present
      $("#btnResetAll").addEventListener("click", resetAll);

      // ============= Initialize
      renderAgentBar();
      // seed default objective + system
      resetAll();

      // start telemetry stream
      startStream();

      // keep activity moving even if stream paused
      setInterval(() => {
        if(!streamOn){
          pushActivity(0.45 + 0.10*Math.random());
          drawActivity();
        }
      }, 900);

      // initial agent brief
      showAgent("orchestrator");

      // ============= Minor UX: set sig badge, dec badge, etc.
      $("#sigBadge").textContent = "live";
      $("#decBadge").textContent = "auto";
    })();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220">

  <title>Battlefield 6 Dashboard</title>

  <!-- JM white TP favicon -->
  <link rel="icon" type="image/png" href="/jmodco/assets/Signature_WhiteTP.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas for Snip -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bf-accent:#ff6a00;
      --bg-overlay: rgba(10,18,32,.90);
      --card-bg: rgba(255,255,255,.11);
      --card-border: rgba(255,255,255,.18);
      --text:#f8fafc;
      --sub:#e5e7eb;
      --title:#93c5fd;
      --nav-bg1: rgba(7,11,20,.75);
      --nav-bg2: rgba(7,11,20,.35);
      --rank-top:#84cc16;
      --rank-bottom:#ef4444;
    }
    body.light{
      --bg-overlay: rgba(255,255,255,.55);
      --card-bg: rgba(0,0,0,.06);
      --card-border: rgba(0,0,0,.18);
      --text:#0b1220;
      --sub:#374151;
      --title:#1d4ed8;
      --nav-bg1: rgba(255,255,255,.8);
      --nav-bg2: rgba(255,255,255,.4);
    }
    body{
      min-height:100vh; color:var(--text);
      background:
        linear-gradient(180deg, var(--bg-overlay), var(--bg-overlay)),
        url('https://assetsio.gnwcdn.com/battlefield-6-2.jpg?width=690&quality=85&format=jpg&dpr=3&auto=webp') center/cover no-repeat fixed;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      -webkit-tap-highlight-color: transparent;
      transition: background-color .2s ease, color .2s ease;
    }
    .card{ background: var(--card-bg); border:1px solid var(--card-border); border-radius:16px; padding:16px }
    .grid-auto{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px }
    .title{ color:var(--title); font-weight:900; font-size:1.25rem; text-align:center; margin-bottom:.75rem }
    .radio{ appearance:none; width:22px; height:22px; border:2px solid var(--title); border-radius:9999px; display:inline-block; position:relative }
    .radio:checked::after{ content:""; position:absolute; inset:4px; border-radius:9999px; background:var(--title) }
    .chip{ background: var(--card-bg); border:1px solid var(--card-border); padding:.5rem .7rem; border-radius:.7rem }
    .btn{
      background:var(--bf-accent); color:#0b0f1a; font-weight:800; letter-spacing:.02em;
      padding:.9rem 1.35rem; border-radius:9999px; box-shadow:0 8px 24px rgba(255,106,0,.18);
      min-width:9rem;
      transition: transform .06s ease, filter .06s ease;
      touch-action: manipulation;
    }
    .btn:hover{ filter:brightness(1.05); transform:translateY(-1px) }
    .btn:active{ transform:translateY(0) }
    .nav{ backdrop-filter: blur(6px); background: linear-gradient(180deg, var(--nav-bg1), var(--nav-bg2)); border-bottom:1px solid var(--card-border) }
    .nav a{ color:var(--sub) }
    .nav .brand{ font-weight:900; letter-spacing:.06em }
    .nav .icon-btn{
      background: var(--card-bg); border:1px solid var(--card-border);
      padding:.55rem .9rem; border-radius:.7rem; font-weight:700; color:var(--text)
    }
    .nav .icon-btn:hover{ background: rgba(255,255,255,.12) }
    .rank-top{ color:var(--rank-top) }
    .rank-bottom{ color:var(--rank-bottom) }
  </style>
</head>

<body class="pb-12">

  <!-- Top Navigation -->
  <nav class="nav sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="https://jordanmoddes.com" target="_blank" rel="noopener" class="brand text-lg">JMOD</a>
      <div class="flex items-center gap-2">
        <a class="icon-btn" href="https://www.ea.com/en/games/battlefield/battlefield-6/player-stats" target="_blank" rel="noopener">Battlefield</a>
        <button id="shareBtn" class="icon-btn">Share</button>
        <button id="snipBtn" class="icon-btn">Snip</button>
        <button id="themeBtn" class="icon-btn">Light</button>
      </div>
    </div>
  </nav>

  <header class="text-center mt-6 mb-6 px-4">
    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight" style="color:var(--title)">Battlefield 6 Stats Dashboard</h1>
    <p class="text-sm" style="color:var(--sub)">
      Pick a platform, enter a gamer tag, then hit <b style="color:var(--bf-accent)">LOAD</b>. Auto-refresh every 60s.
    </p>
  </header>

  <!-- Controls -->
  <form id="controls" class="max-w-6xl mx-auto grid grid-cols-1 gap-3 mb-6 px-4">
    <div class="card grid grid-cols-1 md:grid-cols-[1fr_auto_1fr_auto] gap-3">

      <!-- Platform radios -->
      <div>
        <div class="text-xs" style="color:var(--sub);">Platform</div>
        <div class="flex flex-wrap items-center gap-4 mt-1">
          <label class="flex items-center gap-2 cursor-pointer chip select-none">
            <input class="radio" type="radio" name="platform" value="EA" id="ea" />
            <span class="font-semibold">EA</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer chip select-none">
            <input class="radio" type="radio" name="platform" value="Steam" id="steam" />
            <span class="font-semibold">Steam</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer chip select-none">
            <input class="radio" type="radio" name="platform" value="Xbox" id="xbox" />
            <span class="font-semibold">Xbox</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer chip select-none">
            <input class="radio" type="radio" name="platform" value="PS5" id="ps5" />
            <span class="font-semibold">PS5</span>
          </label>
        </div>
      </div>

      <!-- LOAD button -->
      <div class="flex items-end justify-center">
        <button id="loadBtn" type="submit" class="btn">LOAD</button>
      </div>

      <!-- Gamer tag -->
      <div>
        <div class="text-xs" style="color:var(--sub);">Gamer Tag</div>
        <input id="tag" class="w-full rounded-md px-3 py-3 text-slate-900" placeholder="Enter gamer tag" />
      </div>

      <!-- Last updated -->
      <div class="flex items-end justify-start md:justify-end">
        <div class="chip text-xs" style="color:var(--sub)">Last updated: <span id="updated">—</span></div>
      </div>

    </div>
  </form>

  <main id="content" class="max-w-6xl mx-auto text-sm space-y-4 px-4"></main>

  <footer class="text-center text-xs mt-10 px-4" style="color:var(--sub)">
    Powered by Cloudflare Worker API • Theme inspired by BF6
  </footer>

  <script>
    // ===== set this to your Worker URL =====
    const API_BASE = "https://jmodbattlefield.jmodwork.workers.dev";
    const REFRESH_MS = 60000;

    // Theme toggle
    const themeBtn = document.getElementById("themeBtn");
    const savedTheme = localStorage.getItem("bf-theme");
    if (savedTheme === "light") {
      document.body.classList.add("light");
      themeBtn.textContent = "Dark";
    }
    themeBtn.addEventListener("click", () => {
      document.body.classList.toggle("light");
      const light = document.body.classList.contains("light");
      themeBtn.textContent = light ? "Dark" : "Light";
      localStorage.setItem("bf-theme", light ? "light" : "dark");
    });

    // Share
    document.getElementById("shareBtn").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(location.href);
        const b = document.getElementById("shareBtn");
        b.textContent = "Copied!";
        setTimeout(() => (b.textContent = "Share"), 1200);
      } catch {
        alert("Copy failed. Use the address bar.");
      }
    });

    // Snip
    document.getElementById("snipBtn").addEventListener("click", async () => {
      try {
        const canvas = await html2canvas(document.body, {
          useCORS: true,
          logging: false,
          windowWidth: document.documentElement.scrollWidth,
          windowHeight: document.documentElement.scrollHeight,
        });
        canvas.toBlob(async (blob) => {
          try {
            await navigator.clipboard.write([
              new ClipboardItem({ "image/png": blob }),
            ]);
            const b = document.getElementById("snipBtn");
            b.textContent = "Snipped!";
            setTimeout(() => (b.textContent = "Snip"), 1200);
          } catch {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "battlefield-dashboard.png";
            a.click();
            URL.revokeObjectURL(a.href);
          }
        });
      } catch (e) {
        alert("Screenshot failed.");
        console.error(e);
      }
    });

    // Dashboard Logic
    const params = new URLSearchParams(location.search);
    const defaultTag = params.get("tag") || "notJMODsuspended";
    const defaultPlatform = params.get("platform") || "PS5";

    const tagEl = document.getElementById("tag");
    tagEl.value = defaultTag;

    (document.getElementById(defaultPlatform.toLowerCase()) || document.getElementById("ps5")).checked = true;

    const formEl = document.getElementById("controls");
    const updatedEl = document.getElementById("updated");
    const contentEl = document.getElementById("content");

    let poll = null;
    function getPlatform() {
      const r = document.querySelector("input[name='platform']:checked");
      return r ? r.value : "PS5";
    }
    function startPolling(p, t) {
      stopPolling();
      poll = setInterval(() => load(p, t), REFRESH_MS);
    }
    function stopPolling() {
      if (poll) {
        clearInterval(poll);
        poll = null;
      }
    }

    formEl.addEventListener("submit", (e) => {
      e.preventDefault();
      const platform = getPlatform();
      const tag = tagEl.value.trim() || "notJMODsuspended";
      history.replaceState(null, "", `?${new URLSearchParams({ platform, tag })}`);
      load(platform, tag);
      startPolling(platform, tag);
    });

    function rankSpan(txt) {
      if (!txt) return "";
      const cls =
        txt.toLowerCase().startsWith("top")
          ? "rank-top"
          : txt.toLowerCase().startsWith("bottom")
          ? "rank-bottom"
          : "";
      return cls ? `<span class="${cls}">(${txt})</span>` : `(${txt})`;
    }

    async function load(platform, tag) {
      try {
        const res = await fetch(
          `${API_BASE}/api/summary?platform=${encodeURIComponent(platform)}&tag=${encodeURIComponent(tag)}`,
          { cache: "no-store" }
        );
        if (!res.ok) {
          const msg = await res.text().catch(() => "");
          throw new Error(msg || `API ${res.status}`);
        }
        const data = await res.json();
        render(data);
        updatedEl.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        renderError(err.message || String(err));
        updatedEl.textContent = "—";
        console.error(err);
      }
    }

    function renderError(msg) {
      contentEl.innerHTML = `
        <div class="card" style="background:#7f1d1d;border-color:#fecaca">
          <div class="font-bold mb-1">Couldn’t load data</div>
          <div class="text-xs">${msg}</div>
        </div>`;
    }

    function render(data) {
      const o = data.overview || {};
      contentEl.innerHTML = "";

      contentEl.innerHTML += `
        <section class="card">
          <div class="title">Overview</div>
          <div class="grid-auto">
            <div><b>Kills:</b> ${o.kills ?? "—"} ${o.killsRank ? rankSpan(o.killsRank) : ""}</div>
            <div><b>Deaths:</b> ${o.deaths ?? "—"}</div>
            <div><b>Assists:</b> ${o.assists ?? "—"} ${o.assistsRank ? rankSpan(o.assistsRank) : ""}</div>
            <div><b>Revives:</b> ${o.revives ?? "—"} ${o.revivesRank ? rankSpan(o.revivesRank) : ""}</div>
            <div><b>K/D:</b> ${o.kd ?? "—"}</div>
            <div><b>Kills/Match:</b> ${o.killsPerMatch ?? "—"}</div>
            <div><b>Kills/Minute:</b> ${o.killsPerMinute ?? "—"}</div>
            <div><b>W/L:</b> ${o.wl ?? "—"} ${o.wlRank ? rankSpan(o.wlRank) : ""}</div>
            <div><b>Best Class:</b> ${o.bestClass?.name ?? "—"}</div>
            <div><b>Rank:</b> ${o.rank ?? "—"}</div>
            <div><b>XP:</b> ${o.xp?.toLocaleString?.() ?? "—"}</div>
            <div><b>Matches:</b> ${o.matches ?? "—"}</div>
          </div>
        </section>`;

      contentEl.innerHTML += `
        <section class="card">
          <div class="title">Classes</div>
          <div class="grid-auto">
            ${(data.classes || [])
              .map(
                (x) => `
                <div>
                  <b>${x.name}</b><br/>
                  ⭐ ${x.stars} &nbsp; Kills: ${x.kills}<br/>
                  K/D: ${x.kd} &nbsp; KPM: ${x.kpm}<br/>
                  Revives: ${x.revives} &nbsp; Time: ${x.hours} hrs
                </div>`
              )
              .join("")}
          </div>
        </section>`;

      contentEl.innerHTML += `
        <section class="card">
          <div class="title">Modes</div>
          <div class="grid-auto">
            ${(data.modes || [])
              .map(
                (m) => `
                <div>
                  <b>${m.name}</b><br/>
                  Kills: ${m.kills} &nbsp; KPM: ${m.kpm}<br/>
                  W/L: ${m.wl}% &nbsp; Wins: ${m.wins} • Losses: ${m.losses}<br/>
                  Time: ${m.time} hrs
                </div>`
              )
              .join("")}
          </div>
        </section>`;

      contentEl.innerHTML += `
        <section class="card">
          <div class="title">Top Weapons</div>
          <div class="grid-auto">
            ${(data.weapons || [])
              .map(
                (w) => `
                <div>
                  <b>${w.name}</b><br/>
                  Kills: ${w.kills}<br/>
                  Accuracy: ${w.acc}<br/>
                  KPM: ${w.kpm}
                </div>`
              )
              .join("")}
          </div>
        </section>`;

      contentEl.innerHTML += `
        <section class="card">
          <div class="title">Top Gadgets</div>
          <div class="grid-auto">
            ${(data.gadgets || [])
              .map(
                (g) => `
                <div>
                  <b>${g.name}</b><br/>
                  Kills: ${g.kills}<br/>
                  KPM: ${g.kpm}<br/>
                  Time: ${g.hours} hrs
                </div>`
              )
              .join("")}
          </div>
        </section>`;

      contentEl.innerHTML += `
        <section class="card text-center" style="color:var(--sub)">
          Player: <b>${data.player?.name ?? tagEl.value}</b> (${data.player?.platform ?? getPlatform()}) • Hours: ${
        data.player?.hours ?? "—"
      }
        </section>`;
    }
  </script>

</body>
</html>
